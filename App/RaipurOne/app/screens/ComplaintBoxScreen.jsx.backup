import { Audio } from 'expo-av';
import * as ImagePicker from 'expo-image-picker';
import * as FileSystem from 'expo-file-system';
import * as Location from 'expo-location';
import * as Clipboard from 'expo-clipboard';
import React, { useEffect, useRef, useState } from 'react';
import {
    ActivityIndicator,
    Alert,
    Dimensions,
    Image,
    Platform,
    ScrollView,
    StyleSheet,
    Text,
    TextInput,
    TouchableOpacity,
    View,
} from 'react-native';
import Svg, { Circle, Path } from 'react-native-svg';
import { COLORS } from '../constants/colors';
import { THEME } from '../constants/theme';
import { URGENCY_TYPES } from '../constants/userRoles';
import { complaintService } from '../services/complaintService';
import { uploadImage } from '../services/imageUploadService';
import { aiComplaintService } from '../services/aiComplaintService';

const { width } = Dimensions.get('window');
const SIDEBAR_WIDTH = Math.min(250, width * 0.6);

const SendIcon = () => (
  <Svg width="24" height="24" viewBox="0 0 24 24" fill="none">
    <Path
      d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13"
      stroke={COLORS.surface}
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
  </Svg>
);

const AttachIcon = () => (
  <Svg width="24" height="24" viewBox="0 0 24 24" fill="none">
    <Path
      d="M21.44 11.05L12.25 20.24C11.1242 21.3658 9.59723 21.9983 8.005 21.9983C6.41277 21.9983 4.88583 21.3658 3.76 20.24C2.63417 19.1142 2.00166 17.5872 2.00166 15.995C2.00166 14.4028 2.63417 12.8758 3.76 11.75L12.33 3.18C13.0806 2.42944 14.0967 2.00671 15.155 2.00671C16.2133 2.00671 17.2294 2.42944 17.98 3.18C18.7306 3.93056 19.1533 4.94667 19.1533 6.005C19.1533 7.06333 18.7306 8.07944 17.98 8.83L9.41 17.41C9.03472 17.7853 8.52666 17.9966 7.995 17.9966C7.46334 17.9966 6.95528 17.7853 6.58 17.41C6.20472 17.0347 5.99343 16.5267 5.99343 15.995C5.99343 15.4633 6.20472 14.9553 6.58 14.58L14.07 7.1"
      stroke={COLORS.textLight}
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
  </Svg>
);

const LocationIcon = () => (
  <Svg width="20" height="20" viewBox="0 0 24 24" fill="none">
    <Path
      d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z"
      stroke={COLORS.info}
      strokeWidth="2"
    />
    <Circle cx="12" cy="10" r="3" stroke={COLORS.info} strokeWidth="2" />
  </Svg>
);

const CloseIcon = ({ size = 20, color = COLORS.surface }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M18 6L6 18M6 6L18 18" stroke={color} strokeWidth="2" strokeLinecap="round" />
  </Svg>
);

const MenuIcon = ({ size = 22, color = COLORS.surface }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M3 6H21M3 12H21M3 18H21" stroke={color} strokeWidth="2" strokeLinecap="round" />
  </Svg>
);

const ArrowBackIcon = ({ size = 24, color = '#FFFFFF' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M19 12H5M12 19L5 12L12 5" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
  </Svg>
);

const ChevronLeftIcon = ({ size = 24, color = '#FFFFFF' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M15 18L9 12L15 6" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
  </Svg>
);

const ChevronRightIcon = ({ size = 24, color = '#FFFFFF' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M9 18L15 12L9 6" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
  </Svg>
);

// Department Icons
const WaterIcon = ({ size = 20, color = '#2196F3' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M12 2.69L17.66 8.35C18.87 9.56 19.5 11.15 19.5 12.81C19.5 14.47 18.87 16.06 17.66 17.27C16.45 18.48 14.86 19.11 13.2 19.11C11.54 19.11 9.95 18.48 8.74 17.27C7.53 16.06 6.9 14.47 6.9 12.81C6.9 11.15 7.53 9.56 8.74 8.35L12 2.69Z" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </Svg>
);

const RoadIcon = ({ size = 20, color = '#9E9E9E' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M6 18L18 6M6 6L18 18" stroke={color} strokeWidth="2" strokeLinecap="round"/>
    <Path d="M12 2V6M12 10V14M12 18V22" stroke={color} strokeWidth="2" strokeLinecap="round"/>
  </Svg>
);

const GarbageIcon = ({ size = 20, color = '#4CAF50' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M3 6H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </Svg>
);

const ElectricityIcon = ({ size = 20, color = '#FFC107' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill={color}/>
  </Svg>
);

const WorkerIcon = ({ size = 20, color = '#2196F3' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <Circle cx="12" cy="7" r="4" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <Path d="M12 3V2" stroke={color} strokeWidth="2" strokeLinecap="round"/>
    <Path d="M16 5L17 4" stroke={color} strokeWidth="2" strokeLinecap="round"/>
    <Path d="M8 5L7 4" stroke={color} strokeWidth="2" strokeLinecap="round"/>
  </Svg>
);

const PhoneIcon = ({ size = 16, color = '#666' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M22 16.92V19.92C22.0011 20.1985 21.9441 20.4742 21.8325 20.7293C21.7209 20.9845 21.5573 21.2136 21.3521 21.4019C21.1468 21.5901 20.9046 21.7335 20.6407 21.8227C20.3769 21.9119 20.0974 21.9451 19.82 21.92C16.7428 21.5856 13.787 20.5341 11.19 18.85C8.77382 17.3147 6.72533 15.2662 5.18999 12.85C3.49997 10.2412 2.44824 7.27099 2.11999 4.18C2.095 3.90347 2.12787 3.62476 2.21649 3.36162C2.30512 3.09849 2.44756 2.85669 2.63476 2.65162C2.82196 2.44655 3.0498 2.28271 3.30379 2.17052C3.55777 2.05833 3.83233 2.00026 4.10999 2H7.10999C7.5953 1.99522 8.06579 2.16708 8.43376 2.48353C8.80173 2.79999 9.04207 3.23945 9.10999 3.72C9.23662 4.68007 9.47144 5.62273 9.80999 6.53C9.94454 6.88792 9.97366 7.27691 9.8939 7.65088C9.81415 8.02485 9.62886 8.36811 9.35999 8.64L8.08999 9.91C9.51355 12.4135 11.5864 14.4864 14.09 15.91L15.36 14.64C15.6319 14.3711 15.9751 14.1858 16.3491 14.1061C16.7231 14.0263 17.1121 14.0555 17.47 14.19C18.3773 14.5286 19.3199 14.7634 20.28 14.89C20.7658 14.9585 21.2094 15.2032 21.5265 15.5775C21.8437 15.9518 22.0122 16.4296 22 16.92Z" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </Svg>
);

const DepartmentIcon = ({ size = 16, color = '#666' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <Path d="M9 22V12H15V22" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </Svg>
);

const ClockIcon = ({ size = 16, color = '#FF6B6B' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Circle cx="12" cy="12" r="10" stroke={color} strokeWidth="2"/>
    <Path d="M12 6V12L16 14" stroke={color} strokeWidth="2" strokeLinecap="round"/>
  </Svg>
);

const CheckCircleIcon = ({ size = 20, color = '#4CAF50' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Circle cx="12" cy="12" r="10" stroke={color} strokeWidth="2"/>
    <Path d="M9 12L11 14L15 10" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </Svg>
);

const AlertIcon = ({ size = 20, color = '#FFC107' }) => (
  <Svg width={size} height={size} viewBox="0 0 24 24" fill="none">
    <Circle cx="12" cy="12" r="10" stroke={color} strokeWidth="2"/>
    <Path d="M12 8V12" stroke={color} strokeWidth="2" strokeLinecap="round"/>
    <Circle cx="12" cy="16" r="1" fill={color}/>
  </Svg>
);
 

export default function ComplaintBoxScreen({ user, onBack }) {
  const [messages, setMessages] = useState([]);
  const [sessions, setSessions] = useState([]);
  const [currentSession, setCurrentSession] = useState(null);
  const [inputText, setInputText] = useState('');
  const [selectedMedia, setSelectedMedia] = useState(null);
  const [location, setLocation] = useState(null);
  const [selectedUrgency, setSelectedUrgency] = useState(URGENCY_TYPES[3]); // Normal
  const [loading, setLoading] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(true); // Always visible by default
  const [inputHeight, setInputHeight] = useState(40);
  const [isDarkMode, setIsDarkMode] = useState(false); // Theme toggle
  const [ticketId, setTicketId] = useState(null); // Store ticket ID for fetching responses
  const [adminResponses, setAdminResponses] = useState([]); // Store admin responses
  const [workerAssignments, setWorkerAssignments] = useState([]); // Store worker assignments
  const [safetyPlace, setSafetyPlace] = useState('');
  const [safetyResult, setSafetyResult] = useState(null);
  const [safetyLoading, setSafetyLoading] = useState(false);
  
  // Safety check - moved AFTER hooks
  if (!user || !user.email) {
    return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: '#000' }}>
        <Text style={{ color: '#FFF', fontSize: 18, marginBottom: 20 }}>Loading user data...</Text>
      </View>
    );
  }
  const scrollViewRef = useRef();
  const pollInterval = useRef(null);
  
  // Collapsible complaint IDs state
  const [expandedComplaintIds, setExpandedComplaintIds] = useState({});

  const toggleComplaintId = (id) => {
    setExpandedComplaintIds(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const copyToClipboard = async (text, label = 'ID') => {
    try {
      await Clipboard.setStringAsync(text);
      Alert.alert('Copied!', `${label} copied to clipboard`);
    } catch (error) {
      Alert.alert('Error', 'Failed to copy to clipboard');
    }
  };


  // Suggest urgency from text
  useEffect(() => {
    const text = (inputText || '').toLowerCase();
    if (text.includes('accident') || text.includes('fire') || text.includes('crime') || text.includes('danger')) {
      const u = URGENCY_TYPES.find(u => u.id === 'urgent');
      if (u) setSelectedUrgency(u);
    } else if (text.includes('garbage') || text.includes('pothole') || text.includes('water leak')) {
      const u = URGENCY_TYPES.find(u => u.id === 'public');
      if (u) setSelectedUrgency(u);
    } else {
      const u = URGENCY_TYPES.find(u => u.id === 'normal');
      if (u) setSelectedUrgency(u);
    }
  }, [inputText]);

  useEffect(() => {
    // Request permissions
    (async () => {
      await ImagePicker.requestMediaLibraryPermissionsAsync();
      await ImagePicker.requestCameraPermissionsAsync();
      await Audio.requestPermissionsAsync();
      await Location.requestForegroundPermissionsAsync();
    })();
  }, []);

  useEffect(() => {
    (async () => {
      // Load or create session
      if (!user || !user.email) {
        Alert.alert('Error', 'User not logged in');
        return;
      }
      const res = await complaintService.listSessions(user.email);
      if (res.success && res.data.length > 0) {
        setSessions(res.data);
        setCurrentSession(res.data[0]);
      } else {
        const created = await complaintService.createSession(user.email, 'Complaint');
        if (created.success) {
          setSessions([created.data]);
          setCurrentSession(created.data);
        }
      }
    })();
  }, []);

  useEffect(() => {
    (async () => {
      if (!currentSession) return;
      await loadSessionMessages(currentSession.id);
    })();
  }, [currentSession?.id]);

  // Poll for admin responses every 10 seconds if we have a ticket ID
  useEffect(() => {
    if (!ticketId) return;

    const fetchTicketDetails = async () => {
      const res = await complaintService.getTicketDetails(ticketId);
      if (res.success) {
        // Update responses
        if (res.data.responses && res.data.responses.length > 0) {
          setAdminResponses(res.data.responses);
        }
        // Update worker assignments
        if (res.data.worker_tasks && res.data.worker_tasks.length > 0) {
          setWorkerAssignments(res.data.worker_tasks);
        }
      }
    };

    // Fetch immediately
    fetchTicketDetails();

    // Set up polling interval
    pollInterval.current = setInterval(fetchTicketDetails, 10000); // Poll every 10 seconds

    // Cleanup on unmount or when ticketId changes
    return () => {
      if (pollInterval.current) {
        clearInterval(pollInterval.current);
      }
    };
  }, [ticketId]);

  const loadSessionMessages = async (sessionId) => {
    const res = await complaintService.listMessages(sessionId);
    if (res.success) setMessages(res.data);
  };

  const pickImage = async () => {
    const result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: 'all',
      allowsEditing: true,
      quality: 0.8,
      base64: true,
    });

    if (!result.canceled) {
      setSelectedMedia({ type: 'image', uri: result.assets[0].uri });
    }
  };

  const getLocation = async () => {
    try {
      const loc = await Location.getCurrentPositionAsync({});
      setLocation({
        latitude: loc.coords.latitude,
        longitude: loc.coords.longitude,
      });
      Alert.alert('Location Added', `Lat: ${loc.coords.latitude.toFixed(4)}, Long: ${loc.coords.longitude.toFixed(4)}`);
    } catch (error) {
      Alert.alert('Error', 'Could not fetch location');
    }
  };

  const sendComplaint = async () => {
    if (!inputText.trim() && !selectedMedia) {
      Alert.alert('Error', 'Please enter a message or attach media');
      return;
    }

    if (!currentSession) {
      Alert.alert('Error', 'Please wait for session to load');
      return;
    }

    setLoading(true);

    const newMessage = {
      text: inputText,
      media: selectedMedia,
      location,
      urgency: selectedUrgency,
      created_at: new Date().toISOString(),
      sender: 'user',
    };

    // If we already have a ticketId, post the message as a ticket response so dashboard receives it
    if (ticketId) {
      // Optimistically append to UI
      setMessages((m) => [...m, { id: Date.now(), ...newMessage }]);

      const res = await complaintService.addTicketResponse(ticketId, { text: inputText });
      if (!res.success) {
        Alert.alert('Error', res.error || 'Failed to send message to admin');
      }

      setInputText('');
      setSelectedMedia(null);
      setLocation(null);
      setLoading(false);
      // Scroll after small delay to let layout update
      setTimeout(() => scrollViewRef.current?.scrollToEnd({ animated: true }), 100);
      return;
    }

    // Otherwise create a new ticket (as before) - media required for new tickets
    if (!selectedMedia) {
      Alert.alert('Required', 'Media attachment (image/video/audio) is mandatory for new complaints');
      setLoading(false);
      return;
    }

    // Add message to local UI only
    setMessages((m) => [...m, { id: Date.now(), ...newMessage }]);

    // Generate AI title and department classification
    const aiTitle = aiComplaintService.generateTitle(inputText);
    const department = aiComplaintService.classifyDepartment(inputText);
    const aiUrgency = aiComplaintService.analyzeUrgency(inputText);

    // Update session title locally
    setCurrentSession({ ...currentSession, title: aiTitle });

    // Upload media to Supabase Storage first
    let uploadedUrl = null;
    if (selectedMedia?.uri) {
      try {
        const uploadRes = await uploadImage(selectedMedia.uri, 'complaint-images', user.email?.split('@')[0] || 'user');
        if (uploadRes.success) {
          uploadedUrl = uploadRes.url;
        } else {
          console.warn('Media upload failed:', uploadRes.error);
        }
      } catch (e) {
        console.warn('Media upload error:', e.message);
      }
    }

    // Send to Backend API (creates ticket)
    const complaint = {
      user_email: user.email,
      title: aiTitle,
      description: inputText,
      media_url: uploadedUrl || selectedMedia?.uri || null,
      latitude: location?.latitude,
      longitude: location?.longitude,
      urgency: aiUrgency || selectedUrgency.id,
      department: department, // Add department classification
      phone: user.phone || '',
      address: user.address || '',
      // safety_rating removed for cleaner UI
    };

    const result = await complaintService.createComplaint(complaint);
    
    if (result.success) {
      // Store ticket ID to start polling for responses
      setTicketId(result.data.ticketId || result.data.ticket_id);
      Alert.alert('Success', 'Complaint submitted successfully! You will be notified when admin responds.');
    } else {
      Alert.alert('Error', result.error || 'Failed to submit complaint');
    }

    setInputText('');
    setSelectedMedia(null);
    setLocation(null);
    setLoading(false);
    setTimeout(() => scrollViewRef.current?.scrollToEnd({ animated: true }), 100);
  };

  const createNewSession = async () => {
    // Generate AI title from last complaint or generic
    const aiTitle = inputText 
      ? aiComplaintService.generateTitle(inputText)
      : `Complaint ${sessions.length + 1}`;
    
    const created = await complaintService.createSession(user.email, aiTitle);
    if (created.success) {
      const updated = [created.data, ...sessions];
      setSessions(updated);
      setCurrentSession(created.data);
      setMessages([]);
    }
  };

  const deleteMessage = async (id) => {
    // Remove message from local state only (no Supabase call to avoid UUID errors)
    setMessages((m) => m.filter((x) => x.id !== id));
  };

  return (
    <View style={[styles.container, isDarkMode && styles.containerDark]}>
      {/* Sidebar */}
      {sidebarOpen && (
        <View style={[styles.sidebar, isDarkMode && styles.sidebarDark]}>
          <View style={styles.sidebarHeader}>
            <Text style={styles.sidebarTitle}>My Complaints</Text>
            {width < 768 && (
              <TouchableOpacity onPress={() => setSidebarOpen(false)}>
                <CloseIcon />
              </TouchableOpacity>
            )}
          </View>

          <TouchableOpacity onPress={createNewSession} style={styles.newChatButton}>
            <Text style={styles.newChatText}>+ New Complaint</Text>
          </TouchableOpacity>

          <ScrollView style={styles.sessionList} showsVerticalScrollIndicator={false}>
            {(sessions || []).map((s) => (
              <TouchableOpacity
                key={s.id}
                onPress={() => {
                  setCurrentSession(s);
                  loadSessionMessages(s.id);
                  width < 768 && setSidebarOpen(false);
                }}
                style={[
                  styles.sidebarSessionItem,
                  currentSession?.id === s.id && styles.sidebarSessionItemActive,
                  isDarkMode && styles.sidebarSessionItemDark,
                  currentSession?.id === s.id && isDarkMode && styles.sidebarSessionItemActiveDark,
                ]}
              >
                <Text
                  style={[
                    styles.sidebarSessionText,
                    currentSession?.id === s.id && styles.sidebarSessionTextActive,
                    isDarkMode && styles.sidebarSessionTextDark,
                  ]}
                  numberOfLines={2}
                >
                  {s.title || `Complaint ${(s.id || 'N/A').toString().slice(0, 8)}`}
                </Text>
                <Text style={[styles.sessionDate, isDarkMode && styles.sessionDateDark]}>
                  {s.created_at ? new Date(s.created_at).toLocaleDateString() : 'No date'}
                </Text>
              </TouchableOpacity>
            ))}
          </ScrollView>

          <TouchableOpacity onPress={onBack} style={styles.sidebarBackButton}>
            <Text style={styles.sidebarBackText}>‚Üê Back to Home</Text>
          </TouchableOpacity>
        </View>
      )}

      {/* Collapsible Sidebar Toggle Button (Floating on Right) */}
      {!sidebarOpen && (
        <TouchableOpacity 
          onPress={() => setSidebarOpen(true)} 
          style={styles.floatingSidebarToggle}
        >
          <ChevronLeftIcon size={20} color="#FFFFFF" />
        </TouchableOpacity>
      )}

      {/* Main Content */}
      <View style={[styles.mainContent, isDarkMode && styles.mainContentDark]}>
        {/* Header - BLACK THEME */}
        <View style={[styles.header, isDarkMode && styles.headerDark]}>
          <TouchableOpacity onPress={onBack} style={styles.backButton}>
            <ArrowBackIcon size={24} color="#FFFFFF" />
          </TouchableOpacity>
          <Text style={styles.headerTitle}>Report Complaint</Text>
          <View style={styles.headerButtons}>
            <TouchableOpacity 
              onPress={async () => {
                setLoading(true);
                await loadSessionMessages(currentSession?.id);
                setLoading(false);
              }} 
              style={styles.refreshButton}
            >
              <Text style={styles.refreshIcon}>üîÑ</Text>
            </TouchableOpacity>
            <TouchableOpacity 
              onPress={() => setIsDarkMode(!isDarkMode)} 
              style={styles.themeToggle}
            >
              <Text style={styles.themeToggleText}>{isDarkMode ? '‚òÄÔ∏è' : 'üåô'}</Text>
            </TouchableOpacity>
          </View>
        </View>

        {/* Messages */}
        <View style={styles.keyboardView}>
          <ScrollView
            ref={scrollViewRef}
            style={[styles.messagesContainer, isDarkMode && styles.messagesContainerDark]}
            contentContainerStyle={styles.messagesContent}
            showsVerticalScrollIndicator={false}
          >
            <View style={[styles.infoBox, isDarkMode && styles.infoBoxDark]}>
              <Text style={[styles.infoText, isDarkMode && styles.infoTextDark]}>
                Report civic issues with description, location, and media evidence
              </Text>
            </View>

            {(messages || []).map((msg) => (
              <View key={msg.id} style={[styles.messageCard, isDarkMode && styles.messageCardDark]}>
                {/* Collapsible Complaint Number */}
                <TouchableOpacity 
                  style={styles.complaintNumberHeader}
                  onPress={() => toggleComplaintId(msg.id)}
                  activeOpacity={0.7}
                >
                  <View style={styles.complaintNumberRow}>
                    <Text style={styles.complaintNumberLabel}>Complaint #</Text>
                    <Text style={styles.complaintNumberChevron}>
                      {expandedComplaintIds[msg.id] ? '‚ñº' : '‚ñ∂'}
                    </Text>
                  </View>
                  {expandedComplaintIds[msg.id] && (
                    <View style={styles.complaintNumberExpanded}>
                      <Text style={styles.complaintNumberText}>
                        {msg.ticket_id || msg.id || 'N/A'}
                      </Text>
                      <TouchableOpacity 
                        onPress={() => copyToClipboard(msg.ticket_id || msg.id || 'N/A', 'Complaint ID')}
                        style={styles.copyButton}
                      >
                        <Text style={styles.copyButtonText}>üìã Copy</Text>
                      </TouchableOpacity>
                    </View>
                  )}
                </TouchableOpacity>

                <View style={styles.messageHeader}>
                  <View style={[styles.urgencyBadge, { backgroundColor: (msg.urgency?.color || COLORS.primary) + '20' }]}>
                    <Text
                      style={[styles.urgencyText, { color: msg.urgency?.color || COLORS.primary }]}
                    >
                      {msg.urgency?.label || 'Normal'}
                    </Text>
                  </View>
                  <Text style={styles.timestamp}>
                    {msg.created_at || msg.timestamp ? new Date(msg.created_at || msg.timestamp).toLocaleTimeString() : 'No time'}
                  </Text>
                </View>

                {msg.text ? <Text style={[styles.messageText, isDarkMode && styles.messageTextDark]}>{msg.text}</Text> : null}

                {msg.media && (
                  <Image source={{ uri: msg.media.uri }} style={styles.mediaPreview} />
                )}

                {msg.location && (
                  <View style={styles.locationTag}>
                    <LocationIcon />
                    <Text style={styles.locationText}>
                      {msg.location.latitude.toFixed(4)}, {msg.location.longitude.toFixed(4)}
                    </Text>
                  </View>
                )}

                <View style={styles.messageActions}>
                  <TouchableOpacity onPress={() => deleteMessage(msg.id)}>
                    <Text style={styles.deleteText}>Delete</Text>
                  </TouchableOpacity>
                </View>
              </View>
            ))}

            {/* Admin Responses */}
            {(adminResponses || []).map((response) => (
              <View key={response.id} style={[styles.messageCard, styles.adminMessageCard]}>
                {/* Collapsible Response ID */}
                <TouchableOpacity 
                  style={styles.complaintNumberHeader}
                  onPress={() => toggleComplaintId(response.id)}
                  activeOpacity={0.7}
                >
                  <View style={styles.complaintNumberRow}>
                    <Text style={styles.complaintNumberLabel}>Response #</Text>
                    <Text style={styles.complaintNumberChevron}>
                      {expandedComplaintIds[response.id] ? '‚ñº' : '‚ñ∂'}
                    </Text>
                  </View>
                  {expandedComplaintIds[response.id] && (
                    <View style={styles.complaintNumberExpanded}>
                      <Text style={styles.complaintNumberText}>
                        {response.id || 'N/A'}
                      </Text>
                      <TouchableOpacity 
                        onPress={() => copyToClipboard(response.id || 'N/A', 'Response ID')}
                        style={styles.copyButton}
                      >
                        <Text style={styles.copyButtonText}>üìã Copy</Text>
                      </TouchableOpacity>
                    </View>
                  )}
                </TouchableOpacity>

                <View style={styles.messageHeader}>
                  <View style={[styles.urgencyBadge, { backgroundColor: COLORS.success + '20' }]}>
                    <Text style={[styles.urgencyText, { color: COLORS.success }]}>
                      Admin Response
                    </Text>
                  </View>
                  <Text style={styles.timestamp}>
                    {response.created_at ? new Date(response.created_at).toLocaleTimeString() : 'No time'}
                  </Text>
                </View>

                <Text style={[styles.messageText, styles.adminMessageText]}>
                  {response.message}
                </Text>
              </View>
            ))}

            {/* Worker Assignments */}
            {(workerAssignments || []).map((assignment) => (
              <View key={assignment.id} style={[styles.messageCard, styles.workerAssignmentCard, isDarkMode && styles.workerAssignmentCardDark]}>
                {/* Collapsible Assignment ID */}
                <TouchableOpacity 
                  style={styles.complaintNumberHeader}
                  onPress={() => toggleComplaintId(assignment.id)}
                  activeOpacity={0.7}
                >
                  <View style={styles.complaintNumberRow}>
                    <Text style={styles.complaintNumberLabel}>Assignment #</Text>
                    <Text style={styles.complaintNumberChevron}>
                      {expandedComplaintIds[assignment.id] ? '‚ñº' : '‚ñ∂'}
                    </Text>
                  </View>
                  {expandedComplaintIds[assignment.id] && (
                    <View style={styles.complaintNumberExpanded}>
                      <Text style={styles.complaintNumberText}>
                        {assignment.id || 'N/A'}
                      </Text>
                      <TouchableOpacity 
                        onPress={() => copyToClipboard(assignment.id || 'N/A', 'Assignment ID')}
                        style={styles.copyButton}
                      >
                        <Text style={styles.copyButtonText}>üìã Copy</Text>
                      </TouchableOpacity>
                    </View>
                  )}
                </TouchableOpacity>

                <View style={styles.messageHeader}>
                  <View style={[styles.urgencyBadge, { backgroundColor: '#2196F3' + '20', flexDirection: 'row', alignItems: 'center', gap: 6 }]}>
                    <WorkerIcon size={16} color="#2196F3" />
                    <Text style={[styles.urgencyText, { color: '#2196F3' }]}>
                      Worker Assigned
                    </Text>
                  </View>
                  <Text style={styles.timestamp}>
                    {assignment.assigned_at ? new Date(assignment.assigned_at).toLocaleTimeString() : 'No time'}
                  </Text>
                </View>

                <View style={styles.workerInfo}>
                  <View style={{ flexDirection: 'row', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                    <WorkerIcon size={18} color={isDarkMode ? '#FFFFFF' : COLORS.textDark} />
                    <Text style={[styles.workerName, isDarkMode && styles.workerNameDark]}>
                      {assignment.workers?.name || 'Worker'}
                    </Text>
                  </View>
                  {assignment.workers?.phone && (
                    <View style={{ flexDirection: 'row', alignItems: 'center', gap: 8, marginBottom: 2 }}>
                      <PhoneIcon size={16} color={isDarkMode ? '#AAAAAA' : COLORS.textSecondary} />
                      <Text style={[styles.workerPhone, isDarkMode && styles.workerPhoneDark]}>
                        {assignment.workers.phone}
                      </Text>
                    </View>
                  )}
                  {assignment.workers?.department && (
                    <View style={{ flexDirection: 'row', alignItems: 'center', gap: 8 }}>
                      <DepartmentIcon size={16} color={isDarkMode ? '#AAAAAA' : COLORS.textSecondary} />
                      <Text style={[styles.workerDepartment, isDarkMode && styles.workerDepartmentDark]}>
                        {assignment.workers.department}
                      </Text>
                    </View>
                  )}
                </View>

                {assignment.message && (
                  <Text style={[styles.messageText, styles.workerMessageText, isDarkMode && styles.messageTextDark]}>
                    {assignment.message}
                  </Text>
                )}

                {assignment.deadline && (
                  <View style={{ flexDirection: 'row', alignItems: 'center', gap: 6, marginTop: THEME.spacing.sm }}>
                    <ClockIcon size={16} color={isDarkMode ? '#FF8787' : '#FF6B6B'} />
                    <Text style={[styles.workerDeadline, isDarkMode && styles.workerDeadlineDark]}>
                      Deadline: {assignment.deadline ? new Date(assignment.deadline).toLocaleDateString() : 'No deadline'}
                    </Text>
                  </View>
                )}

                <View style={[styles.workerStatusBadge, { 
                  backgroundColor: assignment.status === 'completed' ? '#4CAF50' : assignment.status === 'in-progress' ? '#2196F3' : '#FFC107',
                  flexDirection: 'row',
                  alignItems: 'center',
                  gap: 6
                }]}>
                  {assignment.status === 'completed' ? <CheckCircleIcon size={16} color="#FFFFFF" /> :
                   assignment.status === 'in-progress' ? <AlertIcon size={16} color="#FFFFFF" /> :
                   <AlertIcon size={16} color="#FFFFFF" />}
                  <Text style={styles.workerStatusText}>
                    {assignment.status === 'completed' ? 'Completed' : 
                     assignment.status === 'in-progress' ? 'In Progress' : 
                     'Pending'}
                  </Text>
                </View>
              </View>
            ))}
          </ScrollView>

          {/* Urgency Selector */}
          <View style={[styles.urgencySelector, isDarkMode && styles.urgencySelectorDark]}>
            <Text style={[styles.urgencyLabel, isDarkMode && styles.urgencyLabelDark]}>Priority:</Text>
            <ScrollView horizontal showsHorizontalScrollIndicator={false}>
              {URGENCY_TYPES.map((urgency) => (
                <TouchableOpacity
                  key={urgency.id}
                  onPress={() => setSelectedUrgency(urgency)}
                  style={[
                    styles.urgencyChip,
                    selectedUrgency.id === urgency.id && {
                      backgroundColor: urgency.color,
                    },
                  ]}
                >
                  <Text
                    style={[
                      styles.urgencyChipText,
                      selectedUrgency.id === urgency.id && { color: COLORS.surface },
                    ]}
                  >
                    {urgency.label}
                  </Text>
                </TouchableOpacity>
              ))}
            </ScrollView>
          </View>

          {/* Safety rating feature removed for cleaner UI */}

          {/* Media Preview */}
          {selectedMedia && (
            <View style={[styles.mediaPreviewContainer, isDarkMode && styles.mediaPreviewContainerDark]}>
              <Image source={{ uri: selectedMedia.uri }} style={styles.mediaPreviewSmall} />
              <TouchableOpacity onPress={() => setSelectedMedia(null)}>
                <CloseIcon size={18} color={COLORS.error} />
              </TouchableOpacity>
            </View>
          )}

          {/* Input Area - Responsive */}
          <View style={[styles.inputContainer, isDarkMode && styles.inputContainerDark]}>
            <TouchableOpacity onPress={pickImage} style={styles.attachButton}>
              <AttachIcon />
            </TouchableOpacity>

            <TouchableOpacity onPress={getLocation} style={styles.locationButton}>
              <LocationIcon />
            </TouchableOpacity>

          <TextInput
            value={inputText}
            onChangeText={setInputText}
            onContentSizeChange={(e) => {
              const height = Math.min(Math.max(40, e.nativeEvent.contentSize.height), 100);
              setInputHeight(height);
            }}
            placeholder="Describe the issue..."
            style={[styles.input, isDarkMode && styles.inputDark, { height: inputHeight }]}
            multiline
            placeholderTextColor={isDarkMode ? '#888888' : COLORS.textLight}
            scrollEnabled={inputHeight === 100}
          />            <TouchableOpacity
              onPress={sendComplaint}
              style={[styles.sendButton, isDarkMode && styles.sendButtonDark]}
              disabled={loading}
            >
              {loading ? (
                <ActivityIndicator color={isDarkMode ? COLORS.primary : COLORS.surface} />
              ) : (
                <SendIcon />
              )}
            </TouchableOpacity>
          </View>
        </View>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F5F5F5',
    flexDirection: 'row',
  },
  containerDark: {
    backgroundColor: '#000000',
  },
  sidebar: {
    width: SIDEBAR_WIDTH,
    backgroundColor: '#FFFFFF',
    borderRightWidth: 1,
    borderRightColor: '#E0E0E0',
    display: 'flex',
    flexDirection: 'column',
    maxHeight: '100%',
    ...THEME.shadow.md,
  },
  sidebarDark: {
    backgroundColor: '#1A1A1A',
    borderRightColor: '#333333',
  },
  sidebarHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: THEME.spacing.md,
    paddingVertical: THEME.spacing.lg,
    borderBottomWidth: 1,
    borderBottomColor: '#E0E0E0',
    backgroundColor: '#000000',
  },
  sidebarTitle: {
    fontSize: THEME.fontSize.lg,
    fontWeight: '700',
    color: '#FFFFFF',
  },
  closeIcon: {
    fontSize: 24,
    color: '#FFFFFF',
    fontWeight: 'bold',
  },
  newChatButton: {
    backgroundColor: '#000000',
    margin: THEME.spacing.md,
    padding: THEME.spacing.md,
    borderRadius: THEME.borderRadius.md,
    alignItems: 'center',
  },
  newChatText: {
    color: '#FFFFFF',
    fontSize: THEME.fontSize.sm,
    fontWeight: '600',
  },
  sessionList: {
    flex: 1,
  },
  sidebarSessionItem: {
    paddingHorizontal: THEME.spacing.md,
    paddingVertical: THEME.spacing.md,
    marginHorizontal: THEME.spacing.sm,
    marginVertical: THEME.spacing.xs,
    borderRadius: THEME.borderRadius.md,
    backgroundColor: '#F5F5F5',
  },
  sidebarSessionItemDark: {
    backgroundColor: '#2A2A2A',
  },
  sidebarSessionItemActive: {
    backgroundColor: '#000000',
    borderLeftWidth: 3,
    borderLeftColor: '#FFFFFF',
    paddingLeft: THEME.spacing.md - 3,
  },
  sidebarSessionItemActiveDark: {
    backgroundColor: '#FFFFFF',
    borderLeftColor: '#000000',
  },
  sidebarSessionText: {
    fontSize: THEME.fontSize.sm,
    color: '#666666',
    fontWeight: '500',
  },
  sidebarSessionTextDark: {
    color: '#CCCCCC',
  },
  sidebarSessionTextActive: {
    color: '#FFFFFF',
    fontWeight: '600',
  },
  sessionDate: {
    fontSize: 10,
    color: '#999999',
    marginTop: 4,
  },
  sessionDateDark: {
    color: '#666666',
  },
  sidebarBackButton: {
    paddingHorizontal: THEME.spacing.md,
    paddingVertical: THEME.spacing.md,
    borderTopWidth: 1,
    borderTopColor: '#E0E0E0',
    alignItems: 'center',
  },
  sidebarBackText: {
    color: '#666666',
    fontSize: THEME.fontSize.sm,
    fontWeight: '500',
  },
  floatingSidebarToggle: {
    position: 'absolute',
    left: 0,
    top: '50%',
    backgroundColor: '#000000',
    paddingVertical: 20,
    paddingHorizontal: 8,
    borderTopRightRadius: 12,
    borderBottomRightRadius: 12,
    zIndex: 1000,
    ...THEME.shadow.lg,
  },
  mainContent: {
    flex: 1,
    flexDirection: 'column',
    backgroundColor: '#FFFFFF',
  },
  mainContentDark: {
    backgroundColor: '#0A0A0A',
  },
  keyboardView: {
    flex: 1,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    backgroundColor: '#000000',
    paddingHorizontal: THEME.spacing.lg,
    paddingVertical: THEME.spacing.md,
    paddingTop: THEME.spacing.xl,
    ...THEME.shadow.md,
  },
  headerDark: {
    backgroundColor: '#000000',
  },
  backButton: {
    padding: THEME.spacing.sm,
  },
  headerTitle: {
    fontSize: THEME.fontSize.lg,
    fontWeight: '700',
    color: '#FFFFFF',
    flex: 1,
    textAlign: 'center',
  },
  headerButtons: {
    flexDirection: 'row',
    gap: THEME.spacing.sm,
  },
  refreshButton: {
    padding: THEME.spacing.sm,
  },
  refreshIcon: {
    fontSize: 20,
  },
  themeToggle: {
    padding: THEME.spacing.sm,
  },
  themeToggleText: {
    fontSize: 20,
  },
  messagesContainer: {
    flex: 1,
    backgroundColor: '#FFFFFF',
  },
  messagesContainerDark: {
    backgroundColor: '#0A0A0A',
  },
  messagesContent: {
    padding: THEME.spacing.md,
    paddingBottom: THEME.spacing.lg,
  },
  infoBox: {
    backgroundColor: '#E8F4FD',
    padding: THEME.spacing.md,
    borderRadius: THEME.borderRadius.md,
    marginBottom: THEME.spacing.md,
  },
  infoBoxDark: {
    backgroundColor: '#1A1A1A',
  },
  infoText: {
    fontSize: THEME.fontSize.sm,
    color: '#1976D2',
  },
  infoTextDark: {
    color: '#64B5F6',
  },
  messageCard: {
    backgroundColor: '#F5F5F5',
    padding: THEME.spacing.md,
    borderRadius: THEME.borderRadius.lg,
    marginBottom: THEME.spacing.md,
    ...THEME.shadow.sm,
    borderLeftWidth: 3,
    borderLeftColor: '#000000',
  },
  messageCardDark: {
    backgroundColor: '#1A1A1A',
    borderLeftColor: '#FFFFFF',
  },
  messageHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: THEME.spacing.sm,
  },
  urgencyBadge: {
    paddingHorizontal: THEME.spacing.sm,
    paddingVertical: 4,
    borderRadius: THEME.borderRadius.sm,
  },
  urgencyText: {
    fontSize: THEME.fontSize.xs,
    fontWeight: '600',
  },
  timestamp: {
    fontSize: THEME.fontSize.xs,
    color: COLORS.textLight,
  },
  messageText: {
    fontSize: THEME.fontSize.md,
    color: COLORS.textPrimary,
    marginBottom: THEME.spacing.sm,
  },
  messageTextDark: {
    color: '#FFFFFF',
  },
  mediaPreview: {
    width: '100%',
    height: 200,
    borderRadius: THEME.borderRadius.md,
    marginBottom: THEME.spacing.sm,
  },
  locationTag: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: THEME.spacing.sm,
  },
  locationText: {
    fontSize: THEME.fontSize.sm,
    color: COLORS.info,
    marginLeft: THEME.spacing.xs,
  },
  urgencySelector: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: COLORS.surface,
    padding: THEME.spacing.md,
    borderTopWidth: 1,
    borderTopColor: COLORS.border,
  },
  urgencySelectorDark: {
    backgroundColor: '#0A0A0A',
    borderTopColor: '#333333',
  },
  urgencyLabel: {
    fontSize: THEME.fontSize.sm,
    fontWeight: '600',
    color: COLORS.textSecondary,
    marginRight: THEME.spacing.sm,
  },
  urgencyLabelDark: {
    color: '#AAAAAA',
  },
  urgencyChip: {
    paddingHorizontal: THEME.spacing.md,
    paddingVertical: THEME.spacing.sm,
    borderRadius: THEME.borderRadius.round,
    backgroundColor: COLORS.background,
    marginRight: THEME.spacing.sm,
  },
  urgencyChipText: {
    fontSize: THEME.fontSize.sm,
    color: COLORS.textSecondary,
  },
  mediaPreviewContainerDark: {
    backgroundColor: '#1A1A1A',
    borderTopColor: '#333333',
  },
  inputContainerDark: {
    backgroundColor: '#0A0A0A',
    borderTopColor: '#333333',
  },
  inputDark: {
    backgroundColor: '#1A1A1A',
    color: '#FFFFFF',
  },
  mediaPreviewContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: COLORS.surface,
    padding: THEME.spacing.sm,
    borderTopWidth: 1,
    borderTopColor: COLORS.border,
  },
  mediaPreviewSmall: {
    width: 60,
    height: 60,
    borderRadius: THEME.borderRadius.md,
    marginRight: THEME.spacing.sm,
  },
  removeMedia: {
    fontSize: 24,
    color: COLORS.error,
  },
  inputContainer: {
    flexDirection: 'row',
    alignItems: 'flex-end',
    backgroundColor: COLORS.surface,
    padding: THEME.spacing.md,
    borderTopWidth: 1,
    borderTopColor: COLORS.border,
    gap: THEME.spacing.sm,
  },
  attachButton: {
    padding: THEME.spacing.sm,
  },
  locationButton: {
    padding: THEME.spacing.sm,
  },
  input: {
    flex: 1,
    backgroundColor: COLORS.background,
    borderRadius: THEME.borderRadius.md,
    paddingHorizontal: THEME.spacing.md,
    paddingVertical: THEME.spacing.sm,
    fontSize: THEME.fontSize.md,
    minHeight: 40,
    maxHeight: 100,
  },
  sendButton: {
    backgroundColor: COLORS.primary,
    padding: THEME.spacing.md,
    borderRadius: THEME.borderRadius.round,
  },
  sendButtonDark: {
    backgroundColor: '#FFFFFF',
  },
  adminMessageCard: {
    backgroundColor: COLORS.success + '10',
    borderLeftWidth: 4,
    borderLeftColor: COLORS.success,
  },
  adminMessageText: {
    fontWeight: '500',
    color: COLORS.textDark,
  },
  workerAssignmentCard: {
    backgroundColor: '#E3F2FD',
    borderLeftWidth: 4,
    borderLeftColor: '#2196F3',
  },
  workerAssignmentCardDark: {
    backgroundColor: '#1A2332',
    borderLeftColor: '#42A5F5',
  },
  workerInfo: {
    marginTop: THEME.spacing.sm,
    marginBottom: THEME.spacing.sm,
  },
  workerName: {
    fontSize: THEME.fontSize.md,
    fontWeight: '600',
    color: COLORS.textDark,
    marginBottom: 4,
  },
  workerNameDark: {
    color: '#FFFFFF',
  },
  workerPhone: {
    fontSize: THEME.fontSize.sm,
    color: COLORS.textSecondary,
    marginBottom: 2,
  },
  workerPhoneDark: {
    color: '#AAAAAA',
  },
  workerDepartment: {
    fontSize: THEME.fontSize.sm,
    color: COLORS.textSecondary,
  },
  workerDepartmentDark: {
    color: '#AAAAAA',
  },
  workerMessageText: {
    fontStyle: 'italic',
    color: COLORS.textSecondary,
    marginTop: THEME.spacing.sm,
  },
  workerDeadline: {
    fontSize: THEME.fontSize.sm,
    color: '#FF6B6B',
    fontWeight: '500',
    marginTop: THEME.spacing.sm,
  },
  workerDeadlineDark: {
    color: '#FF8787',
  },
  workerStatusBadge: {
    alignSelf: 'flex-start',
    paddingHorizontal: THEME.spacing.md,
    paddingVertical: THEME.spacing.xs,
    borderRadius: THEME.borderRadius.round,
    marginTop: THEME.spacing.sm,
  },
  workerStatusText: {
    color: '#FFFFFF',
    fontSize: THEME.fontSize.sm,
    fontWeight: '600',
  },
  safetyContainer: {
    padding: THEME.spacing.md,
    backgroundColor: COLORS.surface,
    borderBottomWidth: 1,
    borderBottomColor: COLORS.border,
  },
  safetyContainerDark: {
    backgroundColor: '#0A0A0A',
    borderBottomColor: '#333',
  },
  safetyLabel: {
    fontSize: THEME.fontSize.sm,
    fontWeight: '700',
    marginBottom: THEME.spacing.sm,
  },
  safetyLabelDark: {
    color: '#FFFFFF',
  },
  safetyRow: {
    flexDirection: 'row',
    gap: THEME.spacing.sm,
    alignItems: 'center',
  },
  safetyInput: {
    flex: 1,
    padding: THEME.spacing.sm,
    backgroundColor: COLORS.background,
    borderRadius: THEME.borderRadius.md,
  },
  safetyButton: {
    backgroundColor: COLORS.primary,
    paddingVertical: THEME.spacing.sm,
    paddingHorizontal: THEME.spacing.md,
    borderRadius: THEME.borderRadius.md,
  },
  safetyButtonText: {
    color: COLORS.surface,
    fontWeight: '600',
  },
  safetyResultBox: {
    marginTop: THEME.spacing.sm,
    padding: THEME.spacing.sm,
    backgroundColor: '#FFF8E1',
    borderRadius: THEME.borderRadius.md,
  },
  safetyResultBoxDark: {
    backgroundColor: '#1A1A1A',
  },
  safetySummary: {
    fontSize: THEME.fontSize.sm,
    marginBottom: THEME.spacing.sm,
  },
  incidentsList: {
    marginTop: THEME.spacing.xs,
  },
  incidentText: {
    fontSize: THEME.fontSize.xs,
    color: COLORS.textSecondary,
  },
  sourcesText: {
    marginTop: THEME.spacing.sm,
    fontSize: THEME.fontSize.xs,
    color: COLORS.textSecondary,
  },
  // Collapsible Complaint Number Styles
  complaintNumberHeader: {
    backgroundColor: '#f8f9fa',
    paddingVertical: 8,
    paddingHorizontal: 12,
    borderRadius: 6,
    marginBottom: 12,
    borderLeftWidth: 3,
    borderLeftColor: COLORS.primary,
  },
  complaintNumberRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  complaintNumberLabel: {
    fontSize: THEME.fontSize.sm,
    fontWeight: '600',
    color: COLORS.textPrimary,
  },
  complaintNumberChevron: {
    fontSize: 12,
    color: COLORS.primary,
    marginLeft: 8,
  },
  complaintNumberExpanded: {
    marginTop: 8,
    paddingTop: 8,
    borderTopWidth: 1,
    borderTopColor: '#e0e0e0',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  complaintNumberText: {
    fontSize: THEME.fontSize.sm,
    fontFamily: 'monospace',
    color: COLORS.textSecondary,
    flex: 1,
  },
  copyButton: {
    backgroundColor: COLORS.primary,
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 6,
    marginLeft: 8,
  },
  copyButtonText: {
    fontSize: THEME.fontSize.xs,
    color: '#FFFFFF',
    fontWeight: '600',
  },
  // Safety Rating Styles
  safetyRatingContainer: {
    backgroundColor: COLORS.surface,
    padding: THEME.spacing.md,
    marginVertical: THEME.spacing.sm,
    borderRadius: THEME.borderRadius.lg,
    borderWidth: 1,
    borderColor: COLORS.border,
  },
  safetyRatingContainerDark: {
    backgroundColor: COLORS.darkCard,
    borderColor: COLORS.darkBorder,
  },
  safetyRatingHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    marginBottom: THEME.spacing.sm,
  },
  safetyRatingLabel: {
    fontSize: THEME.fontSize.md,
    fontWeight: '600',
    color: COLORS.textPrimary,
  },
  safetyRatingLabelDark: {
    color: COLORS.textDark,
  },
  ratingStarsRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    marginVertical: THEME.spacing.sm,
  },
  starButton: {
    padding: 2,
  },
  ratingLabelsRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: THEME.spacing.xs,
  },
  ratingLabelText: {
    fontSize: THEME.fontSize.xs,
    fontWeight: '500',
  },
});